---
layout: post
title: Setup Kubernetes Master on Debian Jessie
tags:
  - data
  - github
  - ci
categories: cloud
published: true
---

Setup a single node Kubernetes master based on the CoreOS way incuding TLS certificates, ETCD and Flannel.

# Install

First we need to make the machine ready and install

1. Docker
2. ETCD
3. Flannel
4. Kubernetes (kubelet and kubectl)

Let's share some environment variables to fix versions.

```bash
```

## Ensure CGroup Memory Accounting works

In order to use Kubernetes on Debian Jessie you need to tweak the kernel parameters
to enable memory accounting for cgroups.

1. If you are using the GRUB bootloader edit `/etc/default/grub` to pass new kernel parameters.

   ```
   GRUB_CMDLINE_LINUX="cgroup_enable=memory swapaccount=1"
   ```
2. Regenerate the `grub.cfg` file on the `/boot` partition with `update-grub`.
3. Restart your machine.


## Install Docker

Follow the [Docker installation options for Debian Jessie](https://docs.docker.com/engine/installation/linux/debian/).

```bash
apt-get install software-properties-common
apt-key adv \
    --keyserver hkp://p80.pool.sks-keyservers.net:80 \
    --recv-keys 58118E89F3A912897C070ADBF76221572C52609D

echo 'deb https://apt.dockerproject.org/repo debian-jessie main' >> /etc/apt/sources.list

apt-get update
apt-get install -y --no-install-recommends docker-engine
```

## Install ETCD

We want to run ETCD on our master node.

```bash
echo 'deb http://cloudfront.debian.net/debian stretch main' >> /etc/apt/sources.list

apt-get update
apt-get install -y --no-install-recommends etcd
```

## Install Flannel

Flannel is the overlay network.

```bash
flannel_upstream="https://github.com/coreos/flannel/releases/download/v0.5.5/flannel-0.5.5-linux-amd64.tar.gz"
mkdir -p /tmp/flannel && cd /tmp/flannel
curl -L "$flannel_upstream" | tar -xz
mv /tmp/flannel/flannel-0.5.5/flanneld /usr/local/bin/flanneld
chmod 755 /usr/local/bin/flanneld
```

## Install Kubernetes

```bash
curl -L -o /usr/local/bin/hyperkube "http://storage.googleapis.com/kubernetes-release/release/v$KUBE_RELEASE/bin/linux/amd64/hyperkube"
chmod 755 /usr/local/bin/hyperkube

curl -L -o /usr/local/bin/kubectl "http://storage.googleapis.com/kubernetes-release/release/v$KUBE_RELEASE/bin/linux/amd64/kubectl"
chmod 755 /usr/local/bin/kubectl
```

# Configure

## Configure ETCD

Edit `/etc/default/etcd`.

```bash
ETCD_NAME="{{ ansible_hostname }}"
ETCD_LISTEN_PEER_URLS="http://{{ ansible_eth0.ipv4.address }}:2380"
ETCD_LISTEN_CLIENT_URLS="http://{{ ansible_eth0.ipv4.address }}:2379,http://localhost:2379"
ETCD_INITIAL_ADVERTISE_PEER_URLS="http://{{ ansible_eth0.ipv4.address }}:2380"
ETCD_INITIAL_CLUSTER={{ ansible_hostname }}=http://{{ ansible_eth0.ipv4.address }}:2380
ETCD_ADVERTISE_CLIENT_URLS="http://{{ ansible_eth0.ipv4.address }}:2379"

```
 

Start the service.

```bash
systemctl start etcd
```

## Configure Flannel

Create a new Systemd unit file for flannel.

```bash
[Unit]
Description=Flanneld
Documentation=https://github.com/coreos/flannel
After=network.target

[Service]
ExecStart=/usr/local/bin/flanneld \
--ip-masq=true \
--iface=eth0 \
--etcd-endpoints=http://${KUBE_MASTER_IP}:2379
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
EOF
```

```bash
systemctl start flanneld
```

### Configure Docker

Docker will read the subnet and MTU from the `subnet.env` file generated by `flanneld`.
Before you restart Docker you need to ensure that the `docker0` bridge is down
so that it is using the correct subnet.

```bash
/sbin/ifconfig docker0 down
brctl delbr docker0
```

```bash
[Unit]
Description=Docker Application Container Engine
Documentation=https://docs.docker.com
After=network.target docker.socket flanneld.service
Requires=docker.socket flanneld.service

[Service]
EnvironmentFile=/run/flannel/subnet.env
Type=notify
ExecStart=/usr/bin/docker daemon -H fd:// \
--bip=\${FLANNEL_SUBNET} \
--mtu=\${FLANNEL_MTU}
MountFlags=slave
LimitNOFILE=1048576
LimitNPROC=1048576
LimitCORE=infinity
TimeoutStartSec=0
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
EOF
```

### Generate TLS certs

To be secure you need to create TLS for Docker and ETCD as well. In this case we are going to
secure Kubernetes only.


### Configure Kubelete

The Kubelet service will run the Kubernetes components inside Docker.

